global:
  scrape_interval: 5s
  evaluation_interval: 5s

scrape_configs:
  # Docker Engine built-in metrics (replaces cAdvisor)
  # Metrics endpoint enabled via daemon.json in Colima VM
  - job_name: docker
    static_configs:
      - targets: ['host.docker.internal:9323']

  # VTGate metrics - query routing layer
  - job_name: vtgate
    metrics_path: /metrics
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    relabel_configs:
      - source_labels: [__meta_docker_container_name]
        regex: '.*vtgate.*'
        action: keep
      - source_labels: [__meta_docker_container_name]
        regex: '/(.*)'
        target_label: instance
      # Extract cell from vtgate_cell1 -> cell1
      - source_labels: [__meta_docker_container_name]
        regex: '.*vtgate_(cell[0-9]+).*'
        target_label: cell
      - source_labels: [__meta_docker_network_ip]
        replacement: '${1}:8080'
        target_label: __address__

  # VTTablet metrics - per-shard database layer
  - job_name: vttablet
    metrics_path: /metrics
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    relabel_configs:
      - source_labels: [__meta_docker_container_name]
        regex: '.*vttablet.*'
        action: keep
      # Extract keyspace, shard, role from vttablet_article_shard1_primary
      - source_labels: [__meta_docker_container_name]
        regex: '.*vttablet_([^_]+)_(shard[0-9]+)_([^-]+).*'
        target_label: keyspace
        replacement: '${1}'
      - source_labels: [__meta_docker_container_name]
        regex: '.*vttablet_([^_]+)_(shard[0-9]+)_([^-]+).*'
        target_label: shard
        replacement: '${2}'
      - source_labels: [__meta_docker_container_name]
        regex: '.*vttablet_([^_]+)_(shard[0-9]+)_([^-]+).*'
        target_label: role
        replacement: '${3}'
      # Short instance name: article_shard1_primary
      - source_labels: [__meta_docker_container_name]
        regex: '.*vttablet_([^-]+)-.*'
        target_label: instance
        replacement: '${1}'
      - source_labels: [__meta_docker_network_ip]
        replacement: '${1}:8080'
        target_label: __address__