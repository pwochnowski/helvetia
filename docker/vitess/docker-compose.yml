# Helvetia: Three-Cell Vitess Setup for Distributed Database
# 
# Architecture:
#   Cell1 (Beijing/DBMS1): User(Beijing), Article(science), Read, Be-Read(science), Popular-Rank(daily)
#   Cell2 (HongKong/DBMS2): User(HongKong), Article(science+technology), Read, Be-Read(science+technology), Popular-Rank(weekly/monthly)
#   Cell3 (Backup): Backup replicas for all keyspaces (enabled with --profile backup)
#
# ===========================================
# YAML Anchors for tablet definitions
# ===========================================
x-vttablet-base: &vttablet-base
  platform: linux/amd64
  command:
    - sh
    - -c
    - /script/vttablet-up.sh
  depends_on:
    - vtctld
  healthcheck:
    interval: 30s
    retries: 15
    test:
      - CMD-SHELL
      - curl -s --fail --show-error localhost:8080/debug/health
    timeout: 10s
  image: vitess/lite:v23.0.0
  volumes:
    - .:/script
    - vitess_backups:/vt/vtdataroot/backups
  networks:
    - vitess_net

x-vttablet-env-base: &vttablet-env-base
  TOPOLOGY_FLAGS: --topo-implementation consul --topo-global-server-address consul1:8500 --topo-global-root vitess/global
  WEB_PORT: 8080
  GRPC_PORT: 15999
  EXTERNAL_DB: 0
  SLEEPTIME: 30
  DB_PORT: ""
  DB_HOST: ""
  DB_USER: ""
  DB_PASS: ""
  DB_CHARSET: ""

services:
  # ===========================================
  # TOPOLOGY SERVICE (Consul Cluster)
  # ===========================================
  consul1:
    platform: linux/amd64
    command: agent -server -bootstrap-expect 1 -ui -disable-host-node-id -client 0.0.0.0
    hostname: consul1
    image: hashicorp/consul:latest
    ports:
      - 8400:8400
      - 8500:8500
      - 8600:8600
    networks:
      - vitess_net

  # ===========================================
  # VTCTLD - Vitess Cluster Management
  # ===========================================
  vtctld:
    platform: linux/amd64
    command:
      - sh
      - -c
      - '/vt/bin/vtctld --topo-implementation consul --topo-global-server-address consul1:8500
        --topo-global-root vitess/global --cell cell1 --cell cell2 --cell cell3
        --service-map "grpc-vtctl,grpc-vtctld" --backup-storage-implementation file 
        --file-backup-storage-root /vt/vtdataroot/backups --logtostderr=true --port 8080 --grpc-port 15999'
    depends_on:
      - consul1
    image: vitess/lite:v23.0.0
    ports:
      - 15000:8080
      - "15999"
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTGATE CELL1 - Query Router (Beijing region)
  # Prefers cell1 tablets for reads, can route to cell2 when needed
  # ===========================================
  vtgate_cell1:
    platform: linux/amd64
    command:
      - sh
      - -c
      - '/script/run-forever.sh /vt/bin/vtgate --topo-implementation consul --topo-global-server-address
        consul1:8500 --topo-global-root vitess/global --logtostderr=true --port 8080 --grpc-port
        15999 --mysql-server-port 15306 --mysql-auth-server-impl none --cell cell1 --cells-to-watch
        cell1,cell2 --tablet-types-to-wait PRIMARY,REPLICA --service-map "grpc-vtgateservice"
        --normalize-queries=true'
    depends_on:
      - vtctld
    image: vitess/lite:v23.0.0
    ports:
      - 15099:8080
      - 15306:15306
    expose:
      - "15999"
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTGATE CELL2 - Query Router (HongKong region)
  # Prefers cell2 tablets for reads, can route to cell1 when needed
  # ===========================================
  vtgate_cell2:
    platform: linux/amd64
    command:
      - sh
      - -c
      - '/script/run-forever.sh /vt/bin/vtgate --topo-implementation consul --topo-global-server-address
        consul1:8500 --topo-global-root vitess/global --logtostderr=true --port 8080 --grpc-port
        15999 --mysql-server-port 15306 --mysql-auth-server-impl none --cell cell2 --cells-to-watch
        cell1,cell2 --tablet-types-to-wait PRIMARY,REPLICA --service-map "grpc-vtgateservice"
        --normalize-queries=true'
    depends_on:
      - vtctld
    image: vitess/lite:v23.0.0
    ports:
      - 15098:8080
      - 15307:15306
    expose:
      - "15999"
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTGATE CELL3 - Query Router (Backup region)
  # Uses backup tablets for read-only operations
  # ===========================================
  vtgate_cell3:
    platform: linux/amd64
    command:
      - sh
      - -c
      - '/script/run-forever.sh /vt/bin/vtgate --topo-implementation consul --topo-global-server-address
        consul1:8500 --topo-global-root vitess/global --logtostderr=true --port 8080 --grpc-port
        15999 --mysql-server-port 15306 --mysql-auth-server-impl none --cell cell3 --cells-to-watch
        cell1,cell2,cell3 --tablet-types-to-wait PRIMARY,REPLICA --service-map "grpc-vtgateservice"
        --normalize-queries=true'
    depends_on:
      - vtctld
    profiles: [backup]
    image: vitess/lite:v23.0.0
    ports:
      - 15097:8080
      - 15308:15306
    expose:
      - "15999"
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTORC - Orchestrator for both cells
  # ===========================================
  vtorc:
    platform: linux/amd64
    command:
      - sh
      - -c
      - /script/vtorc-up.sh
    depends_on:
      - vtctld
      - set_keyspace_durability_policy
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation consul --topo-global-server-address consul1:8500
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - EXTERNAL_DB=0
      - DB_USER=
      - DB_PASS=
    image: vitess/lite:v23.0.0
    ports:
      - 13000:8080
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # SET KEYSPACE DURABILITY POLICY
  # Default: none (single primary). Use DURABILITY_POLICY=semi_sync with backups.
  # ===========================================
  set_keyspace_durability_policy:
    platform: linux/amd64
    command:
      - sh
      - -c
      - /script/set_keyspace_durability_policy.sh
    depends_on:
      - vtctld
    environment:
      - GRPC_PORT=15999
      - DURABILITY_POLICY=${DURABILITY_POLICY:-none}
      - KEYSPACES=user_keyspace article_keyspace read_keyspace beread_keyspace popularrank_keyspace
    image: vitess/lite:v23.0.0
    volumes:
      - .:/script
    networks:
      - vitess_net


  # --- USER KEYSPACE (sharded on region)
  # Shard1: beijing 
  # Shard2: honkong 
  vttablet_user_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 101
      CELL: cell1
      KEYSPACE: user_keyspace
      SHARD: "-80"
      VTHOST: vttablet_user_shard1_primary
    ports:
      - 15101:8080
      - "15999"
      - "3306"

  vttablet_user_shard1_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 102
      CELL: cell3
      KEYSPACE: user_keyspace
      SHARD: "-80"
      VTHOST: vttablet_user_shard1_backup
    ports:
      - 15102:8080
      - "15999"
      - "3306"

  vttablet_user_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 601
      CELL: cell2
      KEYSPACE: user_keyspace
      SHARD: "80-"
      VTHOST: vttablet_user_shard2_primary
    ports:
      - 15601:8080
      - "15999"
      - "3306"

  vttablet_user_shard2_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 602
      CELL: cell3
      KEYSPACE: user_keyspace
      SHARD: "80-"
      VTHOST: vttablet_user_shard2_backup
    ports:
      - 15602:8080
      - "15999"
      - "3306"

  # --- ARTICLE KEYSPACE (sharded on category)  
  # Shard1: science    (Cell1 primary, Cell2 replica)
  # Shard2: technology (Cell2 primary)
  vttablet_article_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 201
      CELL: cell1
      KEYSPACE: article_keyspace
      SHARD: "-80"
      VTHOST: vttablet_article_shard1_primary
    ports:
      - 15201:8080
      - "15999"
      - "3306"

  vttablet_article_shard1_replica:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 701
      CELL: cell2
      KEYSPACE: article_keyspace
      SHARD: "-80"
      VTHOST: vttablet_article_shard1_replica
    ports:
      - 15701:8080
      - "15999"
      - "3306"

  vttablet_article_shard1_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 202
      CELL: cell3
      KEYSPACE: article_keyspace
      SHARD: "-80"
      VTHOST: vttablet_article_shard1_backup
    ports:
      - 15202:8080
      - "15999"
      - "3306"

  # Technology shard - only in Cell2
  vttablet_article_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 711
      CELL: cell2
      KEYSPACE: article_keyspace
      SHARD: "80-"
      VTHOST: vttablet_article_shard2_primary
    ports:
      - 15711:8080
      - "15999"
      - "3306"

  vttablet_article_shard2_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 712
      CELL: cell3
      KEYSPACE: article_keyspace
      SHARD: "80-"
      VTHOST: vttablet_article_shard2_backup
    ports:
      - 15712:8080
      - "15999"
      - "3306"

  # --- READ KEYSPACE (follows User sharding)
  vttablet_read_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 301
      CELL: cell1
      KEYSPACE: read_keyspace
      SHARD: "-80"
      VTHOST: vttablet_read_shard1_primary
    ports:
      - 15301:8080
      - "15999"
      - "3306"

  vttablet_read_shard1_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 302
      CELL: cell3
      KEYSPACE: read_keyspace
      SHARD: "-80"
      VTHOST: vttablet_read_shard1_backup
    ports:
      - 15302:8080
      - "15999"
      - "3306"

  vttablet_read_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 801
      CELL: cell2
      KEYSPACE: read_keyspace
      SHARD: "80-"
      VTHOST: vttablet_read_shard2_primary
    ports:
      - 15801:8080
      - "15999"
      - "3306"

  vttablet_read_shard2_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 802
      CELL: cell3
      KEYSPACE: read_keyspace
      SHARD: "80-"
      VTHOST: vttablet_read_shard2_backup
    ports:
      - 15802:8080
      - "15999"
      - "3306"


  # --- BE-READ KEYSPACE (follows article sharding)
  vttablet_beread_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 401
      CELL: cell1
      KEYSPACE: beread_keyspace
      SHARD: "-80"
      VTHOST: vttablet_beread_shard1_primary
    ports:
      - 15401:8080
      - "15999"
      - "3306"

  vttablet_beread_shard1_replica:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 901
      CELL: cell2
      KEYSPACE: beread_keyspace
      SHARD: "-80"
      VTHOST: vttablet_beread_shard1_replica
    ports:
      - 15901:8080
      - "15999"
      - "3306"

  vttablet_beread_shard1_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 402
      CELL: cell3
      KEYSPACE: beread_keyspace
      SHARD: "-80"
      VTHOST: vttablet_beread_shard1_backup
    ports:
      - 15402:8080
      - "15999"
      - "3306"

  vttablet_beread_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 911
      CELL: cell2
      KEYSPACE: beread_keyspace
      SHARD: "80-"
      VTHOST: vttablet_beread_shard2_primary
    ports:
      - 15911:8080
      - "15999"
      - "3306"

  vttablet_beread_shard2_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 912
      CELL: cell3
      KEYSPACE: beread_keyspace
      SHARD: "80-"
      VTHOST: vttablet_beread_shard2_backup
    ports:
      - 15912:8080
      - "15999"
      - "3306"


  # --- POPULAR-RANK KEYSPACE (sharded on temporalGranularity)
  # Shard1: daily (Cell1 primary)
  # Shard2: weekly (Cell2 primary)
  # Shard3: monthly (Cell2 primary)
  vttablet_popularrank_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 501
      CELL: cell1
      KEYSPACE: popularrank_keyspace
      SHARD: "-80"
      VTHOST: vttablet_popularrank_shard1_primary
    ports:
      - 15501:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard1_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 502
      CELL: cell3
      KEYSPACE: popularrank_keyspace
      SHARD: "-80"
      VTHOST: vttablet_popularrank_shard1_backup
    ports:
      - 15502:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 1001
      CELL: cell2
      KEYSPACE: popularrank_keyspace
      SHARD: 80-c0
      VTHOST: vttablet_popularrank_shard2_primary
    ports:
      - 16001:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard2_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 1002
      CELL: cell3
      KEYSPACE: popularrank_keyspace
      SHARD: 80-c0
      VTHOST: vttablet_popularrank_shard2_backup
    ports:
      - 16002:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard3_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 1011
      CELL: cell2
      KEYSPACE: popularrank_keyspace
      SHARD: c0-
      VTHOST: vttablet_popularrank_shard3_primary
    ports:
      - 16011:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard3_backup:
    <<: *vttablet-base
    profiles: [backup]
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 1012
      CELL: cell3
      KEYSPACE: popularrank_keyspace
      SHARD: c0-
      VTHOST: vttablet_popularrank_shard3_backup
    ports:
      - 16012:8080
      - "15999"
      - "3306"

  # ===========================================
  # SCHEMA LOADER - loads all keyspace schemas
  # ===========================================
  schemaload:
    platform: linux/amd64
    command:
      - sh
      - -c
      - /script/schemaload-all.sh
    depends_on:
      - vtorc
    environment:
      - GRPC_PORT=15999
      - SLEEPTIME=60
    image: vitess/lite:v23.0.0
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTADMIN API - Vitess Admin Backend
  # Manages both DC1 and DC2 clusters
  # ===========================================
  vtadmin-api:
    platform: linux/amd64
    command:
      - sh
      - -c
      - |
        /vt/bin/vtadmin \
          --addr "0.0.0.0:14200" \
          --http-origin "http://localhost:14201" \
          --http-tablet-url-tmpl "http://{{ .Tablet.Hostname }}:8080" \
          --tracer "noop" \
          --logtostderr \
          --alsologtostderr \
          --no-rbac \
          --cluster "id=helvetia-dc1,name=Helvetia DC1,discovery=staticfile,discovery-staticfile-path=/script/vtadmin/discovery-dc1.json,tablet-fqdn-tmpl=http://{{ .Tablet.Hostname }}:8080" \
          --cluster "id=helvetia-dc2,name=Helvetia DC2,discovery=staticfile,discovery-staticfile-path=/script/vtadmin/discovery-dc2.json,tablet-fqdn-tmpl=http://{{ .Tablet.Hostname }}:8080" \
          > /dev/stdout 2>&1
    depends_on:
      - vtctld
      - vtgate_cell1
      - vtgate_cell2
    image: vitess/lite:v23.0.0
    ports:
      - 14200:14200
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTADMIN WEB - Vitess Admin Frontend
  # ===========================================
  vtadmin-web:
    platform: linux/amd64
    image: node:22-alpine
    working_dir: /app
    command:
      - sh
      - -c
      - |
        npm install && \
        VITE_VTADMIN_API_ADDRESS="http://localhost:14200" \
        VITE_ENABLE_EXPERIMENTAL_TABLET_DEBUG_VARS="true" \
        npx serve -l 14201 -s build
    depends_on:
      - vtadmin-api
    ports:
      - 14201:14201
    volumes:
      - ./web/vtadmin:/app
      - ./web/vtadmin/build:/app/build
    networks:
      - vitess_net

  prometheus:
    image: prom/prometheus:latest
    container_name: vitess-prometheus
    user: root
    volumes:
      - ../prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/vitess/prometheus-rules.yml:/etc/prometheus/rules
    ports:
      - 9090:9090
    networks:
      - vitess_net

  cadvisor:
    image: ghcr.io/google/cadvisor:latest
    container_name: vitess-cadvisor
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /sys:/sys:ro
      - /var/run/docker.sock.raw:/var/run/docker.sock:rw
      - /run/containerd/containerd.sock:/run/containerd/containerd.sock:rw
    ports:
      - 9418:8080
    networks:
      - vitess_net

  grafana:
    image: grafana/grafana:10.2.3
    container_name: vitess-grafana
    depends_on:
      - prometheus
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ../prometheus/grafana/provisioning:/etc/grafana/provisioning
    ports:
      - 3001:3000
    networks:
      - vitess_net

  alertmanager:
    image: prom/alertmanager:latest
    container_name: vitess-alertmanager
    ports:
      - "9093:9093"
    command: --config.file=/etc/alertmanager/alertmanager.yml --log.level=debug
    volumes:
      - ../prometheus/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    networks:
      - vitess_net

networks:
  vitess_net:
    driver: bridge

volumes:
  vitess_backups:
