# Helvetia: Two-Cell Vitess Setup for Distributed Database
# 
# Architecture:
#   Cell1 (Beijing/DBMS1): User(Beijing), Article(science), Read, Be-Read(science), Popular-Rank(daily)
#   Cell2 (HongKong/DBMS2): User(HongKong), Article(science+technology), Read, Be-Read(science+technology), Popular-Rank(weekly/monthly)
#
# VReplication handles Article and Be-Read (science category) replication between cells
#
# VTGate per Zone:
#   vtgate_cell1 (port 15306): Primary affinity to cell1, serves Beijing region apps
#   vtgate_cell2 (port 15307): Primary affinity to cell2, serves HongKong region apps
#   Each VTGate can still route cross-cell for writes to PRIMARY tablets

# ===========================================
# YAML Anchors for tablet definitions
# ===========================================
x-vttablet-base: &vttablet-base
  platform: linux/amd64
  command:
    - sh
    - -c
    - /script/vttablet-up.sh
  depends_on:
    - vtctld
  healthcheck:
    interval: 30s
    retries: 15
    test:
      - CMD-SHELL
      - curl -s --fail --show-error localhost:8080/debug/health
    timeout: 10s
  image: vitess/lite:v23.0.0
  volumes:
    - .:/script
  networks:
    - vitess_net

x-vttablet-env-base: &vttablet-env-base
  TOPOLOGY_FLAGS: --topo-implementation consul --topo-global-server-address consul1:8500 --topo-global-root vitess/global
  WEB_PORT: 8080
  GRPC_PORT: 15999
  EXTERNAL_DB: 0
  SLEEPTIME: 30
  DB_PORT: ""
  DB_HOST: ""
  DB_USER: ""
  DB_PASS: ""
  DB_CHARSET: ""

services:
  # ===========================================
  # TOPOLOGY SERVICE (Consul Cluster)
  # ===========================================
  consul1:
    platform: linux/amd64
    command: agent -server -bootstrap-expect 1 -ui -disable-host-node-id -client 0.0.0.0
    hostname: consul1
    image: hashicorp/consul:latest
    ports:
      - 8400:8400
      - 8500:8500
      - 8600:8600
    networks:
      - vitess_net

  # ===========================================
  # VTCTLD - Vitess Cluster Management
  # ===========================================
  vtctld:
    platform: linux/amd64
    command:
      - sh
      - -c
      - '/vt/bin/vtctld --topo-implementation consul --topo-global-server-address consul1:8500
        --topo-global-root vitess/global --cell cell1 --cell cell2
        --service-map "grpc-vtctl,grpc-vtctld" --backup-storage-implementation file 
        --file-backup-storage-root /vt/vtdataroot/backups --logtostderr=true --port 8080 --grpc-port 15999'
    depends_on:
      - consul1
    image: vitess/lite:v23.0.0
    ports:
      - 15000:8080
      - "15999"
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTGATE CELL1 - Query Router (Beijing region)
  # Prefers cell1 tablets for reads, can route to cell2 when needed
  # ===========================================
  vtgate_cell1:
    platform: linux/amd64
    command:
      - sh
      - -c
      - '/script/run-forever.sh /vt/bin/vtgate --topo-implementation consul --topo-global-server-address
        consul1:8500 --topo-global-root vitess/global --logtostderr=true --port 8080 --grpc-port
        15999 --mysql-server-port 15306 --mysql-auth-server-impl none --cell cell1 --cells-to-watch
        cell1,cell2 --tablet-types-to-wait PRIMARY,REPLICA --service-map "grpc-vtgateservice"
        --normalize-queries=true'
    depends_on:
      - vtctld
    image: vitess/lite:v23.0.0
    ports:
      - 15099:8080
      - 15306:15306
    expose:
      - "15999"
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTGATE CELL2 - Query Router (HongKong region)
  # Prefers cell2 tablets for reads, can route to cell1 when needed
  # ===========================================
  vtgate_cell2:
    platform: linux/amd64
    command:
      - sh
      - -c
      - '/script/run-forever.sh /vt/bin/vtgate --topo-implementation consul --topo-global-server-address
        consul1:8500 --topo-global-root vitess/global --logtostderr=true --port 8080 --grpc-port
        15999 --mysql-server-port 15306 --mysql-auth-server-impl none --cell cell2 --cells-to-watch
        cell1,cell2 --tablet-types-to-wait PRIMARY,REPLICA --service-map "grpc-vtgateservice"
        --normalize-queries=true'
    depends_on:
      - vtctld
    image: vitess/lite:v23.0.0
    ports:
      - 15098:8080
      - 15307:15306
    expose:
      - "15999"
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTORC - Orchestrator for both cells
  # ===========================================
  vtorc:
    platform: linux/amd64
    command:
      - sh
      - -c
      - /script/vtorc-up.sh
    depends_on:
      - vtctld
      - set_keyspace_durability_policy
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation consul --topo-global-server-address consul1:8500
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - EXTERNAL_DB=0
      - DB_USER=
      - DB_PASS=
    image: vitess/lite:v23.0.0
    ports:
      - 13000:8080
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # SET KEYSPACE DURABILITY POLICY
  # ===========================================
  set_keyspace_durability_policy:
    platform: linux/amd64
    command:
      - sh
      - -c
      - /script/set_keyspace_durability_policy.sh
    depends_on:
      - vtctld
    environment:
      - GRPC_PORT=15999
      - KEYSPACES=user_keyspace article_keyspace read_keyspace beread_keyspace popularrank_keyspace
    image: vitess/lite:v23.0.0
    volumes:
      - .:/script
    networks:
      - vitess_net


  # --- USER KEYSPACE (sharded on region)
  # Shard1: beijing 
  # Shard2: honkong 
  vttablet_user_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 101
      CELL: cell1
      KEYSPACE: user_keyspace
      SHARD: "-80"
      VTHOST: vttablet_user_shard1_primary
    ports:
      - 15101:8080
      - "15999"
      - "3306"

  vttablet_user_shard1_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 102
      CELL: cell1
      KEYSPACE: user_keyspace
      SHARD: "-80"
      VTHOST: vttablet_user_shard1_backup
    ports:
      - 15102:8080
      - "15999"
      - "3306"

  vttablet_user_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 601
      CELL: cell2
      KEYSPACE: user_keyspace
      SHARD: "80-"
      VTHOST: vttablet_user_shard2_primary
    ports:
      - 15601:8080
      - "15999"
      - "3306"

  vttablet_user_shard2_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 602
      CELL: cell2
      KEYSPACE: user_keyspace
      SHARD: "80-"
      VTHOST: vttablet_user_shard2_backup
    ports:
      - 15602:8080
      - "15999"
      - "3306"

  # --- ARTICLE KEYSPACE (sharded on category)  
  # Shard1: science    (Cell1 primary, Cell2 replica)
  # Shard2: technology (Cell2 primary)
  vttablet_article_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 201
      CELL: cell1
      KEYSPACE: article_keyspace
      SHARD: "-80"
      VTHOST: vttablet_article_shard1_primary
    ports:
      - 15201:8080
      - "15999"
      - "3306"

  vttablet_article_shard1_replica:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 701
      CELL: cell2
      KEYSPACE: article_keyspace
      SHARD: "-80"
      VTHOST: vttablet_article_shard1_replica
    ports:
      - 15701:8080
      - "15999"
      - "3306"

  vttablet_article_shard1_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 202
      CELL: cell1
      KEYSPACE: article_keyspace
      SHARD: "-80"
      VTHOST: vttablet_article_shard1_backup
    ports:
      - 15202:8080
      - "15999"
      - "3306"

  # Technology shard - only in Cell2
  vttablet_article_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 711
      CELL: cell2
      KEYSPACE: article_keyspace
      SHARD: "80-"
      VTHOST: vttablet_article_shard2_primary
    ports:
      - 15711:8080
      - "15999"
      - "3306"

  vttablet_article_shard2_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 712
      CELL: cell2
      KEYSPACE: article_keyspace
      SHARD: "80-"
      VTHOST: vttablet_article_shard2_backup
    ports:
      - 15712:8080
      - "15999"
      - "3306"

  # --- READ KEYSPACE (follows User sharding)
  vttablet_read_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 301
      CELL: cell1
      KEYSPACE: read_keyspace
      SHARD: "-80"
      VTHOST: vttablet_read_shard1_primary
    ports:
      - 15301:8080
      - "15999"
      - "3306"

  vttablet_read_shard1_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 302
      CELL: cell1
      KEYSPACE: read_keyspace
      SHARD: "-80"
      VTHOST: vttablet_read_shard1_backup
    ports:
      - 15302:8080
      - "15999"
      - "3306"

  vttablet_read_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 801
      CELL: cell2
      KEYSPACE: read_keyspace
      SHARD: "80-"
      VTHOST: vttablet_read_shard2_primary
    ports:
      - 15801:8080
      - "15999"
      - "3306"

  vttablet_read_shard2_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 802
      CELL: cell2
      KEYSPACE: read_keyspace
      SHARD: "80-"
      VTHOST: vttablet_read_shard2_backup
    ports:
      - 15802:8080
      - "15999"
      - "3306"


  # --- BE-READ KEYSPACE (follows article sharding)
  vttablet_beread_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 401
      CELL: cell1
      KEYSPACE: beread_keyspace
      SHARD: "-80"
      VTHOST: vttablet_beread_shard1_primary
    ports:
      - 15401:8080
      - "15999"
      - "3306"

  vttablet_beread_shard1_replica:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 901
      CELL: cell2
      KEYSPACE: beread_keyspace
      SHARD: "-80"
      VTHOST: vttablet_beread_shard1_replica
    ports:
      - 15901:8080
      - "15999"
      - "3306"

  vttablet_beread_shard1_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 402
      CELL: cell1
      KEYSPACE: beread_keyspace
      SHARD: "-80"
      VTHOST: vttablet_beread_shard1_backup
    ports:
      - 15402:8080
      - "15999"
      - "3306"

  vttablet_beread_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 911
      CELL: cell2
      KEYSPACE: beread_keyspace
      SHARD: "80-"
      VTHOST: vttablet_beread_shard2_primary
    ports:
      - 15911:8080
      - "15999"
      - "3306"

  vttablet_beread_shard2_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 912
      CELL: cell2
      KEYSPACE: beread_keyspace
      SHARD: "80-"
      VTHOST: vttablet_beread_shard2_backup
    ports:
      - 15912:8080
      - "15999"
      - "3306"


  # --- POPULAR-RANK KEYSPACE (sharded on temporalGranularity)
  # Shard1: daily (Cell1 primary)
  # Shard2: weekly (Cell2 primary)
  # Shard3: monthly (Cell2 primary)
  vttablet_popularrank_shard1_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 501
      CELL: cell1
      KEYSPACE: popularrank_keyspace
      SHARD: "-80"
      VTHOST: vttablet_popularrank_shard1_primary
    ports:
      - 15501:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard1_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 502
      CELL: cell1
      KEYSPACE: popularrank_keyspace
      SHARD: "-80"
      VTHOST: vttablet_popularrank_shard1_backup
    ports:
      - 15502:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard2_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 1001
      CELL: cell2
      KEYSPACE: popularrank_keyspace
      SHARD: 80-c0
      VTHOST: vttablet_popularrank_shard2_primary
    ports:
      - 16001:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard2_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 1002
      CELL: cell2
      KEYSPACE: popularrank_keyspace
      SHARD: 80-c0
      VTHOST: vttablet_popularrank_shard2_backup
    ports:
      - 16002:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard3_primary:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 1011
      CELL: cell2
      KEYSPACE: popularrank_keyspace
      SHARD: c0-
      VTHOST: vttablet_popularrank_shard3_primary
    ports:
      - 16011:8080
      - "15999"
      - "3306"

  vttablet_popularrank_shard3_backup:
    <<: *vttablet-base
    environment:
      <<: *vttablet-env-base
      TABLET_UID: 1012
      CELL: cell2
      KEYSPACE: popularrank_keyspace
      SHARD: c0-
      VTHOST: vttablet_popularrank_shard3_backup
    ports:
      - 16012:8080
      - "15999"
      - "3306"

  # ===========================================
  # SCHEMA LOADER - loads all keyspace schemas
  # ===========================================
  schemaload:
    platform: linux/amd64
    command:
      - sh
      - -c
      - /script/schemaload-all.sh
    depends_on:
      - vtorc
    environment:
      - GRPC_PORT=15999
      - SLEEPTIME=60
    image: vitess/lite:v23.0.0
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTADMIN API - Vitess Admin Backend
  # ===========================================
  vtadmin-api:
    platform: linux/amd64
    command:
      - sh
      - -c
      - |
        /vt/bin/vtadmin \
          --addr "0.0.0.0:14200" \
          --http-origin "http://localhost:14201" \
          --http-tablet-url-tmpl "http://{{ .Tablet.Hostname }}:15{{ .Tablet.Alias.Uid }}" \
          --tracer "noop" \
          --logtostderr \
          --alsologtostderr \
          --no-rbac \
          --cluster "id=helvetia,name=helvetia,discovery=staticfile,discovery-staticfile-path=/script/vtadmin/discovery.json,tablet-fqdn-tmpl=http://{{ .Tablet.Hostname }}:15{{ .Tablet.Alias.Uid }}" \
          > /dev/stdout 2>&1
    depends_on:
      - vtctld
      - vtgate_cell1
      - vtgate_cell2
    image: vitess/lite:v23.0.0
    ports:
      - 14200:14200
    volumes:
      - .:/script
    networks:
      - vitess_net

  # ===========================================
  # VTADMIN WEB - Vitess Admin Frontend
  # ===========================================
  vtadmin-web:
    platform: linux/amd64
    image: node:22-alpine
    working_dir: /app
    command:
      - sh
      - -c
      - |
        npm install && \
        VITE_VTADMIN_API_ADDRESS="http://localhost:14200" \
        VITE_ENABLE_EXPERIMENTAL_TABLET_DEBUG_VARS="true" \
        npx serve -l 14201 -s build
    depends_on:
      - vtadmin-api
    ports:
      - 14201:14201
    volumes:
      - ./web/vtadmin:/app
      - ./web/vtadmin/build:/app/build
    networks:
      - vitess_net

networks:
  vitess_net:
    driver: bridge
